@(event: SystemEvent)(implicit userOpt: Option[UserProfile], req: RequestHeader, globalConfig: global.GlobalConfig, lang: Lang)

@import defines.EventType

@eventBadge(et: Any) = {
    @et match {
        case EventType.creation => {
            <div class="timeline-badge success"><i class="glyphicon glyphicon-floppy-disk"></i></div>
        }
        case EventType.modification | EventType.createDependent | EventType.modifyDependent => {
            <div class="timeline-badge info"><i class="glyphicon glyphicon-refresh"></i></div>
        }
        case EventType.deleteDependent => {
            <div class="timeline-badge warning"><i class="glyphicon glyphicon-remove"></i></div>
        }
        case EventType.ingest => {
            <div class="timeline-badge info"><i class="glyphicon glyphicon-save"></i></div>
        }
        case EventType.link => {
            <div class="timeline-badge info"><i class="glyphicon glyphicon-link"></i></div>
        }
        case EventType.annotation => {
            <div class="timeline-badge success"><i class="glyphicon glyphicon-pencil"></i></div>
        }
        case _ => {
            <div class="timeline-badge"><i class="glyphicon"></i></div>
        }
    }
}
@eventBody(event: SystemEvent, user: models.base.Accessor, et: Any)(html: Html) = {

    <li>
      <div class="timeline-panel-container">
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title">@user.toStringLang</h4>
              <p><small class="text-muted"><i class="glyphicon glyphicon-time"></i> @views.Helpers.relativeDate(event.model.timestamp)</small></p>
            </div>
            <div class="timeline-body">
                <p>@html</p>
                @event.model.logMessage.filterNot(_.trim.isEmpty).map { msg =>
                    <blockquote class="log-message blockquote">@msg</blockquote>
                }
            </div>
          </div>
      </div>
      <div class="timeline-separator">&nbsp;</div>
      <div class="timeline-badge-container">
        <div class="timeline-badge-spacer">&nbsp;</div>
        @eventBadge(et)
      </div>
    </li>
}

@* NB: This will ignore events for which we don't have a type, user, subject, and subject count, which is
        probably how it should be anyway. *@
@for(et <- event.model.eventType; user <- event.actioner; subject <- event.firstSubject; count <- event.childCount) {
    @eventBody(event, user, et) {
        @et match {
            case EventType.modification if user.id == subject.id => {
                <a title="@user.toStringLang" href="@controllers.portal.routes.Portal.browseUser(user.id)">
                    @Messages("portal.activity.modifiedProfile")
                </a>
            }
            case EventType.creation => {
                @Html(Messages("portal.activity.userCreatedItem", p.helpers.linkTo(user), p.helpers.linkTo(subject), count - 1))
            }
            case EventType.modification | EventType.createDependent | EventType.modifyDependent | EventType.deleteDependent => {
                @Html(Messages("portal.activity.userUpdatedItem", p.helpers.linkTo(user), p.helpers.linkTo(subject), count - 1))
            }
            case EventType.ingest => {
                @Html(Messages("portal.activity.userImportedItem", p.helpers.linkTo(user), p.helpers.linkTo(subject), count - 1))
            }
            case EventType.link => {
                @* Annotations and links are special cases. We could like directly to the item but it wouldn't be very useful for the user.
                Instead we link to the scope item (if it's available), with the link/comment id as a fragment. *@
                @event.scope.map { scope =>
                    @if(scope.id == subject.id) {
                        @Html(Messages("portal.activity.userLinkedItem", p.helpers.linkTo(user), p.helpers.linkTo(subject), count - 1))
                    } else {
                        @Html(Messages("portal.activity.userLinkedItem", p.helpers.linkTo(user), p.helpers.linkToWithFragment(scope, "#" + subject.id), count - 1))
                    }
                }
            }
            case EventType.annotation => {
                @event.scope.map { scope =>
                    @if(scope.id == subject.id) {
                        @Html(Messages("portal.activity.userAnnotatedItem", p.helpers.linkTo(user), p.helpers.linkTo(subject), count - 1))
                    } else {
                        @Html(Messages("portal.activity.userAnnotatedItem", p.helpers.linkTo(user), p.helpers.linkToWithFragment(scope, "#" + subject.id), count - 1))
                    }
                }
            }
            case _ => {
                @* Not bothering with other events yet... *@
                @et
            }
        }
    }
}

